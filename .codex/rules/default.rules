# CtrlPlus execution-policy rules for commands run outside the sandbox.
# Most restrictive matching decision wins: forbidden > prompt > allow.

# Block destructive history/file reset operations.
prefix_rule(
    pattern = ["git", "reset", "--hard"],
    decision = "forbidden",
    justification = "Do not discard local work. Use targeted edits instead of hard reset.",
    match = [
        "git reset --hard",
        "git reset --hard HEAD~1",
    ],
    not_match = [
        "git reset --soft HEAD~1",
        "git status",
    ],
)

prefix_rule(
    pattern = ["git", "checkout", "--"],
    decision = "forbidden",
    justification = "Do not discard file changes with checkout --. Edit or restore intentionally.",
    match = [
        "git checkout -- app/page.tsx",
    ],
    not_match = [
        "git checkout main",
    ],
)

prefix_rule(
    pattern = ["git", "clean", ["-fd", "-fdx", "-xdf"]],
    decision = "forbidden",
    justification = "Destructive clean is blocked. Use `git clean -n` to inspect first.",
    match = [
        "git clean -fd",
        "git clean -fdx",
        "git clean -xdf",
    ],
    not_match = [
        "git clean -n",
    ],
)

prefix_rule(
    pattern = ["rm", ["-rf", "-fr"]],
    decision = "forbidden",
    justification = "Recursive forced deletion is blocked. Remove paths with explicit review.",
    match = [
        "rm -rf .next",
        "rm -fr node_modules",
    ],
    not_match = [
        "rm README.md",
    ],
)

prefix_rule(
    pattern = ["Remove-Item", "-Recurse", "-Force"],
    decision = "forbidden",
    justification = "Recursive forced deletion is blocked. Prefer scoped deletes with review.",
    match = [
        "Remove-Item -Recurse -Force .next",
    ],
    not_match = [
        "Remove-Item README.md",
    ],
)

# Prompt before remote or dependency-altering operations.
prefix_rule(
    pattern = ["git", ["push", "pull", "fetch", "merge", "rebase", "cherry-pick"]],
    decision = "prompt",
    justification = "Remote/history-altering git operations require explicit approval.",
    match = [
        "git push origin main",
        "git pull --rebase",
        "git fetch --all",
    ],
    not_match = [
        "git status",
    ],
)

prefix_rule(
    pattern = ["gh"],
    decision = "prompt",
    justification = "GitHub API operations should be approved per invocation.",
    match = [
        "gh pr view 7888",
        "gh issue list",
    ],
    not_match = [
        "git status",
    ],
)

prefix_rule(
    pattern = ["vercel"],
    decision = "prompt",
    justification = "Deploy/environment operations require explicit approval.",
    match = [
        "vercel deploy",
        "vercel env pull",
    ],
    not_match = [
        "pnpm lint",
    ],
)

prefix_rule(
    pattern = ["pnpm", ["add", "remove", "up", "install", "dlx"]],
    decision = "prompt",
    justification = "Dependency and external tooling changes should be approved first.",
    match = [
        "pnpm add zod",
        "pnpm remove lodash",
        "pnpm dlx vercel pull --yes",
    ],
    not_match = [
        "pnpm lint",
        "pnpm test",
    ],
)

prefix_rule(
    pattern = [["curl", "wget", "Invoke-WebRequest"]],
    decision = "prompt",
    justification = "Direct network calls outside sandbox should be explicitly approved.",
    match = [
        "curl https://example.com",
        "wget https://example.com/file.txt",
    ],
    not_match = [
        "rg tenantId",
    ],
)

# Allow common read-only and quality-gate commands.
prefix_rule(
    pattern = ["git", ["status", "diff", "log", "show", "branch", "rev-parse"]],
    decision = "allow",
    justification = "Read-only repository inspection is safe by default.",
)

prefix_rule(
    pattern = ["rg"],
    decision = "allow",
    justification = "Fast text search is safe and preferred for repository exploration.",
)

prefix_rule(
    pattern = ["pnpm", ["lint", "typecheck", "test", "test:e2e"]],
    decision = "allow",
    justification = "Project quality gates are allowed by default.",
)
