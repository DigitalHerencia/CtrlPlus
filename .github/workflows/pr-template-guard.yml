name: PR Template Guard

on:
  pull_request:
    types:
      - opened
      - reopened
      - edited
      - synchronize
      - ready_for_review

permissions:
  contents: read
  pull-requests: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate required PR template sections
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const requiredHeaders = [
              '## Summary',
              '## Architecture / Security Checklist',
              '## Testing'
            ];

            const missingHeaders = requiredHeaders.filter((header) => !body.includes(header));
            const closesIssuePattern =
              /\b(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+(?:[\w.-]+\/[\w.-]+)?#\d+\b/i;

            const issues = [];

            if (missingHeaders.length > 0) {
              issues.push(
                `Missing PR template sections: ${missingHeaders.map((header) => `'${header}'`).join(', ')}.`
              );
            }

            if (!closesIssuePattern.test(body)) {
              issues.push("Missing issue auto-close reference (for example: 'Closes #123').");
            }

            if (issues.length > 0) {
              core.setFailed(issues.join(' '));
            } else {
              core.info('PR body includes required template sections and issue-closing reference.');
            }

