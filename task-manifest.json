{
  "project": "CtrlPlus",
  "architecture_constraints": {
    "tenancy": {
      "host_resolved_tenant_required": true,
      "client_tenant_id_trusted": false,
      "all_tenant_scoped_queries_require_tenant_id": true,
      "required_helpers": [
        "requireTenant",
        "assertTenantScope"
      ]
    },
    "auth": {
      "clerk_orgs_enabled": false,
      "server_side_auth_required": true,
      "required_helpers": [
        "requireAuth",
        "requirePermission"
      ],
      "authorization_client_only_forbidden": true
    },
    "fetcher_action_boundaries": {
      "prisma_in_app_forbidden": true,
      "reads_must_use": "lib/server/fetchers/**",
      "writes_must_use": "lib/server/actions/**",
      "fetchers_read_only": true,
      "actions_write_only": true,
      "action_validation_required": "zod"
    }
  },
  "milestones": [
    {
      "id": "M1",
      "title": "Tenant + Auth Foundations",
      "tasks": [
        {
          "id": "TEN-001",
          "title": "Subdomain tenant resolution and tenant scope guards",
          "file_map": {
            "domain": [
              "features/tenancy/use-cases/resolve-tenant-from-host.ts"
            ],
            "fetchers": [
              "lib/server/fetchers/tenancy/get-tenant-context.ts"
            ],
            "actions": [
              "lib/server/actions/tenancy/assert-tenant-scope-action.ts"
            ],
            "app": [
              "app/(tenant)/layout.tsx",
              "app/middleware.ts"
            ],
            "tests": [
              "tests/unit/tenancy/resolve-tenant-from-host.test.ts",
              "tests/integration/tenancy/get-tenant-context.test.ts"
            ]
          },
          "requires_migration": true,
          "requires_e2e": false,
          "test_types": [
            "unit",
            "integration"
          ]
        },
        {
          "id": "AUTH-001",
          "title": "Tenant membership RBAC guards for read/write operations",
          "file_map": {
            "domain": [
              "features/authz/use-cases/evaluate-permission.ts"
            ],
            "fetchers": [
              "lib/server/fetchers/authz/get-tenant-membership.ts"
            ],
            "actions": [
              "lib/server/actions/authz/require-permission-action.ts"
            ],
            "app": [
              "app/(auth)/[[...sign-in]]/page.tsx",
              "app/(auth)/[[...sign-up]]/page.tsx"
            ],
            "tests": [
              "tests/unit/authz/evaluate-permission.test.ts",
              "tests/integration/authz/get-tenant-membership.test.ts"
            ]
          },
          "requires_migration": true,
          "requires_e2e": false,
          "test_types": [
            "unit",
            "integration"
          ]
        }
      ]
    },
    {
      "id": "M2",
      "title": "Catalog Readiness + Wrap Listing Performance Validation",
      "tasks": [
        {
          "id": "CAT-001",
          "title": "Tenant-scoped wraps listing and detail fetchers for app/(tenant)/wraps/page.tsx",
          "file_map": {
            "domain": [
              "features/catalog/use-cases/list-wraps.ts"
            ],
            "fetchers": [
              "lib/server/fetchers/catalog/get-wraps-list.ts"
            ],
            "actions": [],
            "app": [
              "app/(tenant)/wraps/page.tsx"
            ],
            "tests": [
              "tests/unit/catalog/list-wraps.test.ts",
              "tests/integration/catalog/get-wraps-list.test.ts"
            ]
          },
          "requires_migration": true,
          "requires_e2e": false,
          "test_types": [
            "unit",
            "integration"
          ]
        },
        {
          "id": "PERF-002",
          "title": "Performance validation for wraps listing RSC render path",
          "workload_shape": {
            "seed_data": {
              "tenants": 1,
              "wrapDesignsPerTenant": 500,
              "activeRatio": 0.8,
              "filterProfiles": [
                "default-unfiltered",
                "finish=matte&vehicleType=suv",
                "search=carbon"
              ]
            },
            "request_mix": {
              "default-unfiltered": 0.6,
              "filtered": 0.3,
              "search": 0.1
            },
            "concurrency": 10,
            "warmup_requests": 50,
            "measurement_requests": 400
          },
          "environment_assumptions": {
            "runtime": "Next.js production build with Node.js 20",
            "database": "Neon Postgres staging tier in same region as app",
            "deployment": "Vercel preview equivalent CPU/memory class",
            "cache_state": "run once cold and once warm with fetch cache primed"
          },
          "percentile_window": {
            "metric": "server response latency for app/(tenant)/wraps/page.tsx",
            "method": "sliding window p95 over last 400 measured requests, excluding warmup",
            "report_units": "milliseconds"
          },
          "sla_thresholds": {
            "p95_ms": 900,
            "p99_ms": 1200
          },
          "acceptance_criteria": [
            "CI perf harness fails when measured p95 exceeds 900ms for warm-cache run.",
            "CI perf harness fails when measured p99 exceeds 1200ms for warm-cache run.",
            "PR includes baseline and post-change wraps page p95/p99 metrics and delta."
          ],
          "harness": {
            "scripts": [
              "pnpm perf:wraps-page",
              "pnpm perf:assert"
            ],
            "artifacts": [
              "tests/perf/results/wraps-page-baseline.json",
              "tests/perf/results/wraps-page-current.json"
            ]
          },
          "requires_migration": false,
          "requires_e2e": false,
          "test_types": [
            "integration"
          ]
        }
      ]
    },
    {
      "id": "M3",
      "title": "Visualizer v1",
      "tasks": [
        {
          "id": "VIS-001",
          "title": "Template-based preview fast path",
          "file_map": {
            "domain": [
              "features/visualizer/use-cases/generate-template-preview.ts"
            ],
            "fetchers": [
              "lib/server/fetchers/visualizer/get-vehicle-template.ts"
            ],
            "actions": [
              "lib/server/actions/visualizer/create-template-preview-action.ts"
            ],
            "app": [
              "app/(tenant)/visualizer/page.tsx"
            ],
            "tests": [
              "tests/unit/visualizer/generate-template-preview.test.ts",
              "tests/integration/visualizer/create-template-preview-action.test.ts",
              "tests/e2e/visualizer/template-preview.spec.ts"
            ]
          },
          "requires_migration": true,
          "requires_e2e": true,
          "test_types": [
            "unit",
            "integration",
            "e2e"
          ]
        },
        {
          "id": "VIS-002",
          "title": "Upload-based preview with fallback and deterministic cache",
          "file_map": {
            "domain": [
              "features/visualizer/use-cases/generate-upload-preview.ts",
              "features/visualizer/use-cases/compute-preview-cache-key.ts"
            ],
            "fetchers": [
              "lib/server/fetchers/visualizer/get-preview-cache-entry.ts"
            ],
            "actions": [
              "lib/server/actions/visualizer/create-upload-preview-action.ts"
            ],
            "app": [
              "app/(tenant)/visualizer/page.tsx"
            ],
            "tests": [
              "tests/unit/visualizer/compute-preview-cache-key.test.ts",
              "tests/integration/visualizer/create-upload-preview-action.test.ts",
              "tests/e2e/visualizer/upload-fallback.spec.ts"
            ]
          },
          "requires_migration": true,
          "requires_e2e": true,
          "test_types": [
            "unit",
            "integration",
            "e2e"
          ]
        },
        {
          "id": "PERF-003",
          "title": "Performance validation for visualizer actions (template and upload fallback)",
          "workload_shape": {
            "template_path": {
              "requests": 300,
              "concurrency": 15,
              "vehicle_templates": 30
            },
            "upload_path": {
              "requests": 120,
              "concurrency": 5,
              "upload_size_mb_distribution": {
                "p50": 4,
                "p95": 10
              },
              "fallback_trigger_rate": 0.15
            },
            "warmup_requests": 40
          },
          "environment_assumptions": {
            "runtime": "Next.js server actions in production mode",
            "image_pipeline": "same storage backend and image worker settings as staging",
            "network": "single region; no cross-region blob access",
            "cache_state": "template cache primed before warm measurements"
          },
          "percentile_window": {
            "metric": "action completion latency for create-template-preview-action and create-upload-preview-action",
            "method": "rolling 15-minute window p95 computed from per-action histograms; warmup excluded",
            "report_units": "milliseconds"
          },
          "sla_thresholds": {
            "template_p95_ms": 1000,
            "upload_p95_ms": 20000
          },
          "acceptance_criteria": [
            "Fail validation if template preview action p95 exceeds 1000ms in warm-cache run.",
            "Fail validation if upload preview action p95 exceeds 20000ms under defined upload workload.",
            "Fail validation if fallback success rate drops below 99% when upload path fails.",
            "PR includes baseline and post-change visualizer metrics (template p95 and upload p95)."
          ],
          "harness": {
            "scripts": [
              "pnpm perf:visualizer-actions",
              "pnpm perf:assert"
            ],
            "artifacts": [
              "tests/perf/results/visualizer-baseline.json",
              "tests/perf/results/visualizer-current.json"
            ]
          },
          "requires_migration": false,
          "requires_e2e": true,
          "test_types": [
            "integration",
            "e2e"
          ]
        }
      ]
    },
    {
      "id": "M5",
      "title": "Billing and Stripe Reliability",
      "tasks": [
        {
          "id": "BILL-001",
          "title": "Invoice creation and Stripe Checkout session flow",
          "file_map": {
            "domain": [
              "features/billing/use-cases/create-invoice.ts"
            ],
            "fetchers": [
              "lib/server/fetchers/billing/get-invoice-by-id.ts"
            ],
            "actions": [
              "lib/server/actions/billing/create-invoice-action.ts",
              "lib/server/actions/billing/create-stripe-checkout-session-action.ts"
            ],
            "app": [
              "app/(tenant)/checkout/page.tsx"
            ],
            "tests": [
              "tests/unit/billing/create-invoice.test.ts",
              "tests/integration/billing/create-stripe-checkout-session-action.test.ts",
              "tests/e2e/billing/checkout.spec.ts"
            ]
          },
          "requires_migration": true,
          "requires_e2e": true,
          "test_types": [
            "unit",
            "integration",
            "e2e"
          ]
        },
        {
          "id": "BILL-002",
          "title": "Stripe webhook signature verification and idempotent reconciliation",
          "requirements": [
            "Verify Stripe webhook signatures before processing any event payload.",
            "Treat Stripe event metadata (tenantId and invoiceId) as untrusted input and validate both values against persisted invoice ownership before mutation.",
            "Reject and record mismatched tenant scope when metadata tenantId does not match the invoice tenantId in the database.",
            "Enforce server-side trust boundaries: tenant context for webhook processing must come from validated Stripe metadata and database lookups only, never client-derived request context.",
            "Persist an AuditEvent describing webhook processing outcomes (success, rejection, idempotent duplicate)."
          ],
          "acceptance_criteria": [
            "Webhook processing succeeds for a valid signed Stripe event when tenantId/invoiceId metadata matches database ownership and reconciliation updates invoice and booking state.",
            "Webhook processing rejects events with mismatched tenant scope, performs no cross-tenant mutation, and returns an explicit failure outcome.",
            "Webhook processing is idempotent for duplicate Stripe event IDs and does not re-apply side effects.",
            "An AuditEvent is written for each webhook processing outcome, including success, rejection, and duplicate-event short-circuit paths.",
            "Integration tests in tests/integration/stripe-webhook.test.ts cover valid metadata processing, tenant mismatch rejection, duplicate idempotency, and audit event persistence."
          ],
          "file_map": {
            "domain": [
              "features/billing/use-cases/reconcile-stripe-payment.ts"
            ],
            "fetchers": [
              "lib/server/fetchers/billing/get-payment-event-by-stripe-event-id.ts"
            ],
            "actions": [
              "lib/server/actions/billing/handle-stripe-webhook-action.ts"
            ],
            "app": [
              "app/api/stripe/webhook/route.ts"
            ],
            "tests": [
              "tests/unit/billing/reconcile-stripe-payment.test.ts",
              "tests/integration/stripe-webhook.test.ts",
              "tests/e2e/billing/webhook-payment-confirmation.spec.ts"
            ]
          },
          "requires_migration": true,
          "requires_e2e": true,
          "test_types": [
            "unit",
            "integration",
            "e2e"
          ]
        }
      ]
    },
    {
      "id": "M8",
      "title": "Platform Observability and Performance Governance",
      "tasks": [
        {
          "id": "PERF-001",
          "title": "Dedicated issue: performance instrumentation foundation",
          "issue_type": "platform",
          "issue_summary": "Add OpenTelemetry spans, latency histograms, and regression budget checks for wraps page and visualizer actions.",
          "deliverables": [
            "Instrumentation hooks for app/(tenant)/wraps/page.tsx and visualizer server actions.",
            "Exported p50/p95/p99 metrics to CI artifacts and dashboard sink.",
            "Regression gate consumed by pnpm perf:assert."
          ],
          "acceptance_criteria": [
            "Issue is linked to milestone M8 and tracked on project board with Domain=Platform.",
            "Instrumentation emits tenant-safe metrics with no PII in labels.",
            "CI fails when metric export or regression assertion step is missing."
          ],
          "requires_migration": false,
          "requires_e2e": false,
          "test_types": [
            "integration"
          ]
        }
      ]
    }
  ],
  "quality_gates": {
    "require_lint": true,
    "require_typecheck": true,
    "require_unit": true,
    "require_integration": true,
    "require_e2e": true
  }
}
